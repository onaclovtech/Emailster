<!DOCTYPE html>
<html ng-app="myapp" manifest="covers.appcache">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.6/angular.min.js"></script>
    <script src="https://cdn.firebase.com/js/client/1.0.11/firebase.js"></script>
    <script src="https://cdn.firebase.com/libs/angularfire/0.7.1/angularfire.min.js"></script>
   <!-- Latest compiled and minified CSS -->
   <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
<style type="text/css">
<!--
   /* Move down content because we have a fixed navbar that is 50px tall */
body {
  padding-top: 50px;
  padding-bottom: 20px;
}
-->
</style>
   <!-- Optional theme -->
   <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
  </head>
  <body ng-controller="MyController">
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Really Awesome App Idea</a>
        </div>

      </div>
    </div>
    <!--<div ng-view></div>-->
    <h3>If you're interested in this really awesome product, why don't you drop off your email and we'll let you know when we're ready to show it off.
       <input type="text" ng-model="name" placeholder="Name:" style="width:100%;font-size:24px;">
       <input type="text" ng-model="email" placeholder="Email:" style="width:100%;font-size:24px;">
       <button type="button" class="btn btn-primary" ng-click="addEmail(name, email)">Submit</button>
       {{result}} <br />
       {{status}} <br />
       {{data}}
       {{id}}
    
 <script>
      var app = angular.module("myapp", ["firebase"]);
       app.config(function($httpProvider) {
    //Enable cross domain calls
    $httpProvider.defaults.useXDomain = true;
    delete $httpProvider.defaults.headers.common['X-Requested-With'];
    $httpProvider.defaults.headers.post["Content-Type"] = "application/x-www-form-urlencoded";
    
});
      function MyController($scope, $firebase, $http) {
        var FB = ""; // Enter in your FB name
        var ref = new Firebase(FB);
        $scope.emailList = $firebase(ref.limit(1));
        validateEmail = function (email) { 
           var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
           return re.test(email);
} 
        $scope.addEmail = function(name, email) {
            if (validateEmail(email))
            {
               var newResult = $scope.emailList.$add({"name" : name, "email" : email, "validated" : false}).then(function(ref) {
  $log.log(ref.name());                // Key name of the added data.
  Sendgrid.send(email, name, "Click to Confirm", "This Please click on this link to confirm your email address: \n\n http://onaclovtech.com/apps/rockstar/" + String(ref.name()) + "\n\n");
});
               console.log(newResult);
               console.log(newResult.name);
               $scope.id = newResult.name();
               // This isn't working because for some reason when I add a new email, it's not returning the ID
               // If you remove the "result" from the text it'll work.
               //Sendgrid.send(email, name, "Click to Confirm", "This Please click on this link to confirm your email address: \n\n http://onaclovtech.com/apps/rockstar/" + String(result.name()) + "\n\n", "tyson@onaclovtech.com");
               $scope.email = "";
               $scope.name = "";
               // message = Please visit the following link to verify onaclovtech.com/apps/email/result
               //Sendgrid(message, email);
               
            }
         
        }
        var Sendgrid = {
         api_user : "", // Enter your Send Grid Username
         api_key : "",  // Enter your Send Grid Key
         from : "",
         send : function(to, toname, subject, text){
           $scope.method = 'GET';
           $scope.url = "https://api.sendgrid.com/api/mail.send.json?";
           $http({method: $scope.method, url: $scope.url  + "api_user=" + this.api_user + 
                                                            "&api_key=" + this.api_key + 
                                                            "&to=" + to + 
                                                            "&subject=" + subject + 
                                                            "&text=" + text + 
                                                            "&from=" + from}).
           success(function(data, status) {
             $scope.result = "Email Sent";
             $scope.data = data;
               $scope.status=status;
            }).
            error(function(data, status) {
               $scope.data = data;
               $scope.status=status;
               $scope.result = "Error Sending Email";
            });
         }
     }
        // Add a router for the result, and bam we're in awesome shape!
       
        
      }
      
    </script>
  </body>
</html>
